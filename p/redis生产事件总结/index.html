<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="å…³äºç”Ÿäº§çš„ä¸€æ¬¡åˆ‡æ¢å¯¼è‡´çš„ç”Ÿäº§äº‹ä»¶"><title>Redisç”Ÿäº§äº‹ä»¶æ€»ç»“</title><link rel=canonical href=https://sturdy-space-chainsaw-595gwwvqgjvf4vpx-1313.app.github.dev/p/redis%E7%94%9F%E4%BA%A7%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BB%93/><link rel=stylesheet href=/scss/style.min.b0e76e98cdd4f7082d1fc36f7af7e0843a81201db2197c03ca426751dc923735.css><meta property='og:title' content="Redisç”Ÿäº§äº‹ä»¶æ€»ç»“"><meta property='og:description' content="å…³äºç”Ÿäº§çš„ä¸€æ¬¡åˆ‡æ¢å¯¼è‡´çš„ç”Ÿäº§äº‹ä»¶"><meta property='og:url' content='https://sturdy-space-chainsaw-595gwwvqgjvf4vpx-1313.app.github.dev/p/redis%E7%94%9F%E4%BA%A7%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BB%93/'><meta property='og:site_name' content='Ccinoçš„ä¸ªäººåšå®¢'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2025-12-16T00:00:00+00:00'><meta property='article:modified_time' content='2025-12-16T00:00:00+00:00'><meta property='og:image' content='https://sturdy-space-chainsaw-595gwwvqgjvf4vpx-1313.app.github.dev/redis.jpeg'><meta name=twitter:title content="Redisç”Ÿäº§äº‹ä»¶æ€»ç»“"><meta name=twitter:description content="å…³äºç”Ÿäº§çš„ä¸€æ¬¡åˆ‡æ¢å¯¼è‡´çš„ç”Ÿäº§äº‹ä»¶"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://sturdy-space-chainsaw-595gwwvqgjvf4vpx-1313.app.github.dev/redis.jpeg'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/toux_hu_6634aef6e8005c85.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ’™</span></figure><div class=site-meta><h1 class=site-name><a href=/>Ccinoçš„ä¸ªäººåšå®¢</a></h1><h2 class=site-description>å‘½è¿çš„ç¤¼ç›’ï¼Œåªè¦è¿˜æ²¡æ‰“å¼€å°±è¿˜æœ‰æ›´å¤§çš„æƒŠå–œç­‰ç€ä½ </h2></div></header><ol class=menu-social><li><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>ä¸»é¡µ</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>å½’æ¡£</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>æœç´¢</span></a></li><li><a href=/%E5%8F%8B%E9%93%BE/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>å‹é“¾</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#äº‹ä»¶æ¦‚è¿°>äº‹ä»¶æ¦‚è¿°</a><ol><li><a href=#äº‹ä»¶æ—¶é—´>äº‹ä»¶æ—¶é—´</a></li><li><a href=#å½±å“èŒƒå›´>å½±å“èŒƒå›´</a></li></ol></li><li><a href=#äº‹ä»¶èƒŒæ™¯>äº‹ä»¶èƒŒæ™¯</a><ol><li><a href=#å†å²æ“ä½œ2022å¹´>å†å²æ“ä½œï¼ˆ2022å¹´ï¼‰</a></li><li><a href=#äº‹ä»¶è§¦å‘æ¡ä»¶>äº‹ä»¶è§¦å‘æ¡ä»¶</a></li></ol></li><li><a href=#å½±å“åˆ†æ>å½±å“åˆ†æ</a><ol><li><a href=#ç›´æ¥è¡¨ç°>ç›´æ¥è¡¨ç°</a></li><li><a href=#é…ç½®åˆ†æ>é…ç½®åˆ†æ</a></li></ol></li><li><a href=#æ ¹æœ¬åŸå› åˆ†æ>æ ¹æœ¬åŸå› åˆ†æ</a><ol><li><a href=#ç¬¬ä¸€å±‚åŸå› æ¶æ„é…ç½®ç¼ºé™·>ç¬¬ä¸€å±‚åŸå› ï¼šæ¶æ„é…ç½®ç¼ºé™·</a></li><li><a href=#ç¬¬äºŒå±‚åŸå› å®¢æˆ·ç«¯æ¡†æ¶é™åˆ¶>ç¬¬äºŒå±‚åŸå› ï¼šå®¢æˆ·ç«¯æ¡†æ¶é™åˆ¶</a></li><li><a href=#ç¬¬ä¸‰å±‚åŸå› é›†ç¾¤é…ç½®ä¸ä¸šåŠ¡è¦æ±‚çš„çŸ›ç›¾>ç¬¬ä¸‰å±‚åŸå› ï¼šé›†ç¾¤é…ç½®ä¸ä¸šåŠ¡è¦æ±‚çš„çŸ›ç›¾</a></li></ol></li><li><a href=#è§£å†³æ–¹æ¡ˆä¸ä¿®å¤è¿‡ç¨‹>è§£å†³æ–¹æ¡ˆä¸ä¿®å¤è¿‡ç¨‹</a><ol><li><a href=#ç¬¬ä¸€é˜¶æ®µç´§æ€¥æ¢å¤åº”ç”¨å¯åŠ¨>ç¬¬ä¸€é˜¶æ®µï¼šç´§æ€¥æ¢å¤ï¼ˆåº”ç”¨å¯åŠ¨ï¼‰</a></li><li><a href=#ç¬¬äºŒé˜¶æ®µé•¿æ•ˆè§£å†³æ‹“æ‰‘ç®¡ç†>ç¬¬äºŒé˜¶æ®µï¼šé•¿æ•ˆè§£å†³ï¼ˆæ‹“æ‰‘ç®¡ç†ï¼‰</a></li></ol></li><li><a href=#ç»éªŒæ•™è®­ä¸æ”¹è¿›æªæ–½>ç»éªŒæ•™è®­ä¸æ”¹è¿›æªæ–½</a><ol><li><a href=#é…ç½®ç®¡ç†æ”¹è¿›>é…ç½®ç®¡ç†æ”¹è¿›</a></li><li><a href=#æ¡†æ¶å‡çº§ä¸ä¼˜åŒ–>æ¡†æ¶å‡çº§ä¸ä¼˜åŒ–</a></li><li><a href=#ç›‘æ§ä¸å‘Šè­¦å®Œå–„>ç›‘æ§ä¸å‘Šè­¦å®Œå–„</a></li><li><a href=#åº”æ€¥å“åº”æ”¹è¿›>åº”æ€¥å“åº”æ”¹è¿›</a></li></ol></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/redis%E7%94%9F%E4%BA%A7%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BB%93/><img src=/redis.jpeg loading=lazy alt="Featured image of post Redisç”Ÿäº§äº‹ä»¶æ€»ç»“"></a></div><div class=article-details><header class=article-category><a href=/categories/redis/>Redis</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/redis%E7%94%9F%E4%BA%A7%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BB%93/>Redisç”Ÿäº§äº‹ä»¶æ€»ç»“</a></h2><h3 class=article-subtitle>å…³äºç”Ÿäº§çš„ä¸€æ¬¡åˆ‡æ¢å¯¼è‡´çš„ç”Ÿäº§äº‹ä»¶</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-12-16T00:00:00Z>Dec 16, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 12 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h1 id=redisç”Ÿäº§äº‹ä»¶æ€»ç»“æŠ¥å‘Š>Redisç”Ÿäº§äº‹ä»¶æ€»ç»“æŠ¥å‘Š</h1><h2 id=äº‹ä»¶æ¦‚è¿°>äº‹ä»¶æ¦‚è¿°</h2><h3 id=äº‹ä»¶æ—¶é—´>äº‹ä»¶æ—¶é—´</h3><ul><li><strong>è§¦å‘æ—¶é—´</strong>ï¼š2025å¹´4æœˆ</li><li><strong>æ¢å¤æ—¶é—´</strong>ï¼š2025å¹´4æœˆ(å½“å¤©)</li><li><strong>æŒç»­æ—¶é—´</strong>ï¼šçº¦1å°æ—¶</li></ul><h3 id=å½±å“èŒƒå›´>å½±å“èŒƒå›´</h3><ul><li><strong>ç³»ç»Ÿå½±å“</strong>ï¼šRedisé›†ç¾¤ä¸å¯ç”¨</li><li><strong>ä¸šåŠ¡å½±å“</strong>ï¼šä¾èµ–Redisçš„ç›¸å…³é‡‘èæœåŠ¡åŠŸèƒ½å—å½±å“</li><li><strong>åº”ç”¨å½±å“</strong>ï¼šå…¨éƒ¨åº”ç”¨é‡å¯æ—¶æ— æ³•æ­£å¸¸å¯åŠ¨</li></ul><h2 id=äº‹ä»¶èƒŒæ™¯>äº‹ä»¶èƒŒæ™¯</h2><h3 id=å†å²æ“ä½œ2022å¹´>å†å²æ“ä½œï¼ˆ2022å¹´ï¼‰</h3><p>2022å¹´è¿›è¡Œçš„Redisé›†ç¾¤åˆ‡æ¢æ¼”ç»ƒä¸­ï¼Œç”±äºæ“ä½œé…ç½®é—®é¢˜ï¼Œå¯¼è‡´ä¸¤ä¸ªä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰è¢«éƒ¨ç½²åœ¨åŒä¸€æ•°æ®ä¸­å¿ƒã€‚è¿™ä¸€é…ç½®éšæ‚£ä¸€ç›´å­˜åœ¨ä½†æœªæš´éœ²ï¼Œç›´åˆ°æœ¬æ¬¡äº‹ä»¶è§¦å‘ã€‚</p><h3 id=äº‹ä»¶è§¦å‘æ¡ä»¶>äº‹ä»¶è§¦å‘æ¡ä»¶</h3><p>2025å¹´4æœˆï¼Œè¯¥æ•°æ®ä¸­å¿ƒå‘ç”Ÿæ•…éšœï¼Œå¯¼è‡´ä½äºåŒä¸€ä¸­å¿ƒçš„ä¸¤ä¸ªmasterèŠ‚ç‚¹åŒæ—¶ä¸å¯ç”¨ã€‚æ ¹æ®Redisé›†ç¾¤çš„æ•…éšœè½¬ç§»æœºåˆ¶ï¼š</p><ul><li>ä¸€åŠçš„slotï¼ˆå“ˆå¸Œæ§½ï¼‰æ­£å¸¸å®Œæˆäº†è‡ªåŠ¨è½¬ç§»</li><li>å¦ä¸€åŠslotå› ä¸¤ä¸ªmasteråœ¨åŒä¸€ä½ç½®ï¼Œæ— æ³•æ»¡è¶³æ•…éšœè½¬ç§»æ¡ä»¶ï¼Œå¯¼è‡´è¿ç§»å¤±è´¥</li></ul><h2 id=å½±å“åˆ†æ>å½±å“åˆ†æ</h2><h3 id=ç›´æ¥è¡¨ç°>ç›´æ¥è¡¨ç°</h3><ol><li><strong>é›†ç¾¤çŠ¶æ€å¼‚å¸¸</strong>ï¼šéƒ¨åˆ†æ•°æ®åˆ†ç‰‡ä¸å¯ç”¨</li><li><strong>åº”ç”¨å¯åŠ¨å¤±è´¥</strong>ï¼šæ‰€æœ‰åº”ç”¨ç¨‹åºé‡å¯æ—¶å‡æ— æ³•æ­£å¸¸å¯åŠ¨</li><li><strong>æœåŠ¡ä¸å¯ç”¨</strong>ï¼šä¾èµ–Redisçš„ä¸šåŠ¡åŠŸèƒ½å—é™æˆ–ä¸å¯ç”¨</li></ol><h3 id=é…ç½®åˆ†æ>é…ç½®åˆ†æ</h3><p><strong>å…³é”®é…ç½®</strong>ï¼š<code>cluster-require-full-coverage=yes</code></p><ul><li><strong>é…ç½®å«ä¹‰</strong>ï¼šè¦æ±‚é›†ç¾¤æ‰€æœ‰slotéƒ½å¿…é¡»è¢«è¦†ç›–æ—¶ï¼Œé›†ç¾¤æ‰å¯¹å¤–æä¾›å†™æœåŠ¡</li><li><strong>é‡‘èç³»ç»Ÿè¦æ±‚</strong>ï¼šé“¶è¡Œé‡‘èç³»ç»Ÿå› å¼ºä¸€è‡´æ€§è¦æ±‚ï¼Œå¿…é¡»è®¾ç½®æ­¤å‚æ•°ä¸ºyes</li><li><strong>é—®é¢˜è¡¨ç°</strong>ï¼šå½“éƒ¨åˆ†slotä¸å¯ç”¨æ—¶ï¼Œæ•´ä¸ªé›†ç¾¤æ‹’ç»å†™æ“ä½œï¼Œå¯¼è‡´æœåŠ¡ä¸å¯ç”¨</li></ul><h2 id=æ ¹æœ¬åŸå› åˆ†æ>æ ¹æœ¬åŸå› åˆ†æ</h2><h3 id=ç¬¬ä¸€å±‚åŸå› æ¶æ„é…ç½®ç¼ºé™·>ç¬¬ä¸€å±‚åŸå› ï¼šæ¶æ„é…ç½®ç¼ºé™·</h3><ol><li><strong>è¿åéƒ¨ç½²åŸåˆ™</strong>ï¼šä¸¤ä¸ªmasterèŠ‚ç‚¹éƒ¨ç½²åœ¨åŒä¸€æ•°æ®ä¸­å¿ƒï¼Œè¿åé«˜å¯ç”¨éƒ¨ç½²åŸåˆ™</li><li><strong>å†å²é—ç•™éšæ‚£</strong>ï¼š2022å¹´æ¼”ç»ƒåçš„é…ç½®æœªæ¢å¤ï¼Œéšæ‚£é•¿æœŸå­˜åœ¨</li></ol><h3 id=ç¬¬äºŒå±‚åŸå› å®¢æˆ·ç«¯æ¡†æ¶é™åˆ¶>ç¬¬äºŒå±‚åŸå› ï¼šå®¢æˆ·ç«¯æ¡†æ¶é™åˆ¶</h3><p><strong>è‡ªç ”æ¡†æ¶ä¸­Jedis 2.9ç‰ˆæœ¬å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</strong></p><div class=table-wrapper><table><thead><tr><th style=text-align:left>é—®é¢˜é¡¹</th><th style=text-align:left>å…·ä½“è¡¨ç°</th><th style=text-align:left>å½±å“ç¨‹åº¦</th></tr></thead><tbody><tr><td style=text-align:left>æ‹“æ‰‘è‡ªåŠ¨åˆ·æ–°</td><td style=text-align:left>ä¸æ”¯æŒè‡ªåŠ¨åˆ·æ–°é›†ç¾¤æ‹“æ‰‘</td><td style=text-align:left>é«˜</td></tr><tr><td style=text-align:left>å¯åŠ¨è¿æ¥ç­–ç•¥</td><td style=text-align:left>å¯åŠ¨æ—¶è¿æ¥æ‰€æœ‰é…ç½®èŠ‚ç‚¹</td><td style=text-align:left>ä¸¥é‡</td></tr><tr><td style=text-align:left>æ•…éšœå®¹å¿åº¦</td><td style=text-align:left>é‡åˆ°æ•…éšœèŠ‚ç‚¹ç›´æ¥å¤±è´¥</td><td style=text-align:left>ä¸¥é‡</td></tr></tbody></table></div><p><strong>å¯åŠ¨æµç¨‹ç¼ºé™·</strong>ï¼š</p><pre class=mermaid>
   graph TD
 A[åº”ç”¨å¯åŠ¨] --> B[Jedisåˆå§‹åŒ–]
    B --> C[è¿æ¥æ‰€æœ‰é…ç½®èŠ‚ç‚¹]
    C --> D{é‡åˆ°æ•…éšœèŠ‚ç‚¹?}
    D -->|æ˜¯| E[è¿æ¥å¤±è´¥]
    D -->|å¦| F[å¯åŠ¨æˆåŠŸ]
    E --> G[å¯åŠ¨ç»ˆæ­¢]
</pre><p>åˆå§‹åŒ–æ§½ä½ç¼“å­˜æ—¶ JedisClusterConnectionHandlerä¸­æºç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initializeSlotsCache</span><span class=p>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>HostAndPort</span><span class=o>&gt;</span><span class=w> </span><span class=n>startNodes</span><span class=p>,</span><span class=w> </span><span class=n>GenericObjectPoolConfig</span><span class=w> </span><span class=n>poolConfig</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>password</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>HostAndPort</span><span class=w> </span><span class=n>hostAndPort</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>startNodes</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Jedis</span><span class=w> </span><span class=n>jedis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Jedis</span><span class=p>(</span><span class=n>hostAndPort</span><span class=p>.</span><span class=na>getHost</span><span class=p>(),</span><span class=w> </span><span class=n>hostAndPort</span><span class=p>.</span><span class=na>getPort</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>password</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>jedis</span><span class=p>.</span><span class=na>auth</span><span class=p>(</span><span class=n>password</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cache</span><span class=p>.</span><span class=na>discoverClusterNodesAndSlots</span><span class=p>(</span><span class=n>jedis</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>JedisConnectionException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// try next nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>jedis</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>jedis</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¼šåœ¨authæ—¶è¿›è¡Œcontectè¿æ¥ï¼Œä¹Ÿå°±å¯¼è‡´äº†å¯åŠ¨æ—¶è¿æ¥æ•…éšœèŠ‚ç‚¹æŠ›å‡ºJedisConnectionExceptionæœ€ç»ˆå¯åŠ¨å¤±è´¥ã€‚</p><h3 id=ç¬¬ä¸‰å±‚åŸå› é›†ç¾¤é…ç½®ä¸ä¸šåŠ¡è¦æ±‚çš„çŸ›ç›¾>ç¬¬ä¸‰å±‚åŸå› ï¼šé›†ç¾¤é…ç½®ä¸ä¸šåŠ¡è¦æ±‚çš„çŸ›ç›¾</h3><ul><li><strong>ä¸šåŠ¡è¦æ±‚</strong>ï¼šå¼ºä¸€è‡´æ€§ â†’ <code>cluster-require-full-coverage=yes</code></li><li><strong>å¯ç”¨æ€§è¦æ±‚</strong>ï¼šéƒ¨åˆ†æ•…éšœæ—¶ä»éœ€æœåŠ¡ â†’ ä¸ä¸Šè¿°é…ç½®çŸ›ç›¾</li><li><strong>ç¼ºä¹åº”ç”¨ä¸­é—´æ–¹æ¡ˆ</strong>ï¼šéƒ¨åˆ†åŠŸèƒ½æœªè®¾è®¡redisé›†ç¾¤æ•…éšœæ—¶çš„é™çº§ç­–ç•¥</li></ul><h2 id=è§£å†³æ–¹æ¡ˆä¸ä¿®å¤è¿‡ç¨‹>è§£å†³æ–¹æ¡ˆä¸ä¿®å¤è¿‡ç¨‹</h2><h3 id=ç¬¬ä¸€é˜¶æ®µç´§æ€¥æ¢å¤åº”ç”¨å¯åŠ¨>ç¬¬ä¸€é˜¶æ®µï¼šç´§æ€¥æ¢å¤ï¼ˆåº”ç”¨å¯åŠ¨ï¼‰</h3><p><strong>æ–¹æ¡ˆ</strong>ï¼šä¿®æ”¹åº”ç”¨å¯åŠ¨å¥åº·æ£€æŸ¥æœºåˆ¶</p><ol><li><strong>å¥åº·æ£€æŸ¥è¿‡æ»¤</strong>ï¼šå¯åŠ¨æ—¶è·³è¿‡é…ç½®ä¸­çš„æ•…éšœèŠ‚ç‚¹</li><li><strong>å®ç°æ–¹å¼</strong>ï¼š<ul><li>åœ¨Jedisåˆå§‹åŒ–å‰å¢åŠ èŠ‚ç‚¹å¥åº·æ£€æŸ¥</li><li>ä»…è¿æ¥å¥åº·çš„èŠ‚ç‚¹å®Œæˆåˆå§‹åŒ–</li><li>è®°å½•æ•…éšœèŠ‚ç‚¹ä¿¡æ¯ç”¨äºåç»­æ¢å¤</li></ul></li></ol><p><strong>ä¿®å¤ä»£ç ç¤ºä¾‹</strong>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.slf4j.Logger</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.slf4j.LoggerFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.stereotype.Component</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.HashSet</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Set</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.concurrent.CopyOnWriteArraySet</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author huqinuo
</span></span></span><span class=line><span class=cl><span class=cm> * @version 1.0
</span></span></span><span class=line><span class=cl><span class=cm> * @description RedisèŠ‚ç‚¹ä¸Šä¸‹æ–‡ç®¡ç†å™¨
</span></span></span><span class=line><span class=cl><span class=cm> * @data 2025/12/1 9:25
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RedisNodeContext</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Logger</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LoggerFactory</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=n>RedisNodeContext</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>unhealthyNodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CopyOnWriteArraySet</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>allNodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CopyOnWriteArraySet</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * åˆå§‹åŒ–æ–¹æ³•ï¼Œä»é™æ€æ•°æ®åŠ è½½
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initializeFromStaticData</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>RedisHealthChecker</span><span class=p>.</span><span class=na>isHealthCheckCompleted</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>allNodes</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>allNodes</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>RedisHealthChecker</span><span class=p>.</span><span class=na>getAllNodes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>unhealthyNodes</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>unhealthyNodes</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>RedisHealthChecker</span><span class=p>.</span><span class=na>getUnhealthyNodes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;RedisNodeContext initialized from static data: {}/{} nodes healthy&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>getHealthyNodeCount</span><span class=p>(),</span><span class=w> </span><span class=n>allNodes</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ·»åŠ ä¸å¥åº·èŠ‚ç‚¹
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addUnhealthyNode</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unhealthyNodes</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ç§»é™¤ä¸å¥åº·èŠ‚ç‚¹ï¼ˆèŠ‚ç‚¹æ¢å¤æ—¶è°ƒç”¨ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>removeUnhealthyNode</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unhealthyNodes</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å–æ‰€æœ‰ä¸å¥åº·èŠ‚ç‚¹
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getUnhealthyNodes</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashSet</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>unhealthyNodes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦ä¸å¥åº·
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isNodeUnhealthy</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>unhealthyNodes</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è®¾ç½®æ‰€æœ‰èŠ‚ç‚¹
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setAllNodes</span><span class=p>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>nodes</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>allNodes</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>allNodes</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>nodes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å–æ‰€æœ‰èŠ‚ç‚¹
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getAllNodes</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashSet</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>allNodes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ·»åŠ å•ä¸ªèŠ‚ç‚¹
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addNode</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>allNodes</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å–å¥åº·èŠ‚ç‚¹æ•°é‡
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getHealthyNodeCount</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>allNodes</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>unhealthyNodes</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å–ä¸å¥åº·èŠ‚ç‚¹æ•°é‡
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getUnhealthyNodeCount</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>unhealthyNodes</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>open.ref.redis</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>è‡ªç ”åŒ….RedisFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Configuration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.DependsOn</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.scheduling.annotation.EnableScheduling</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author huqinuo
</span></span></span><span class=line><span class=cl><span class=cm> * @version 1.0
</span></span></span><span class=line><span class=cl><span class=cm> * @description Redisé…ç½®ç±»(å¥åº·æ£€æŸ¥ä½¿ç”¨)
</span></span></span><span class=line><span class=cl><span class=cm> * @data 2025/12/1 15:31
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EnableScheduling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RedisClusterConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * redisèŠ‚ç‚¹ä¸Šä¸‹æ–‡
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DependsOn</span><span class=p>(</span><span class=s>&#34;redisHealthChecker&#34;</span><span class=p>)</span><span class=w>  </span><span class=c1>// ç¡®ä¿åœ¨å¥åº·æ£€æŸ¥åæ‰§è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RedisNodeContext</span><span class=w> </span><span class=nf>redisNodeContext</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RedisNodeContext</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RedisNodeContext</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>context</span><span class=p>.</span><span class=na>initializeFromStaticData</span><span class=p>();</span><span class=w> </span><span class=c1>// ä»é™æ€æ•°æ®åˆå§‹åŒ–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>context</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ‹“æ‰‘åˆ·æ–°å™¨
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@DependsOn</span><span class=p>(</span><span class=s>&#34;redisNodeContext&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RedisClusterTopologyRefresher</span><span class=w> </span><span class=nf>redisClusterTopologyRefresher</span><span class=p>(</span><span class=nd>@Autowired</span><span class=w> </span><span class=n>RedisNodeContext</span><span class=w> </span><span class=n>redisNodeContext</span><span class=p>,</span><span class=w> </span><span class=n>RedisFactory</span><span class=w> </span><span class=n>redisFactory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RedisClusterTopologyRefresher</span><span class=p>(</span><span class=n>redisNodeContext</span><span class=p>,</span><span class=n>redisFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>open.ref.redis</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>open.svc.dict.Const</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.slf4j.Logger</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.slf4j.LoggerFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.BeansException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.config.BeanFactoryPostProcessor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.config.ConfigurableListableBeanFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.EnvironmentAware</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.core.env.ConfigurableEnvironment</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.core.env.Environment</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.core.env.MapPropertySource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.stereotype.Component</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>redis.clients.jedis.Jedis</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author huqinuo
</span></span></span><span class=line><span class=cl><span class=cm> * @version 1.0
</span></span></span><span class=line><span class=cl><span class=cm> * @description Redisé›†ç¾¤è¿æ¥å¥åº·æ£€æŸ¥
</span></span></span><span class=line><span class=cl><span class=cm> * @data 2025/12/1 10:02
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RedisHealthChecker</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>BeanFactoryPostProcessor</span><span class=p>,</span><span class=w> </span><span class=n>EnvironmentAware</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ConfigurableEnvironment</span><span class=w> </span><span class=n>environment</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Logger</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LoggerFactory</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=n>RedisHealthChecker</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>unhealthyNodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashSet</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>allNodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashSet</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>CONNECTION_TIMEOUT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>healthCheckCompleted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setEnvironment</span><span class=p>(</span><span class=n>Environment</span><span class=w> </span><span class=n>environment</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>environment</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ConfigurableEnvironment</span><span class=p>)</span><span class=w> </span><span class=n>environment</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>postProcessBeanFactory</span><span class=p>(</span><span class=n>ConfigurableListableBeanFactory</span><span class=w> </span><span class=n>beanFactory</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>BeansException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>healthCheckCompleted</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w> </span><span class=c1>// é¿å…é‡å¤æ‰§è¡Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isRedisClusterEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Redis cluster is not enabled, skip health check&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>healthCheckCompleted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>oriRedisNodeUrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getOriRedisNodeUrl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Objects</span><span class=p>.</span><span class=na>isNull</span><span class=p>(</span><span class=n>oriRedisNodeUrl</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;Application does not have Redis configuration&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>healthCheckCompleted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ‰§è¡Œå¥åº·æ£€æŸ¥å¹¶æ›´æ–°é…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>performInitialHealthCheck</span><span class=p>(</span><span class=n>oriRedisNodeUrl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>healthCheckCompleted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ³¨å†Œé™æ€ä¸Šä¸‹æ–‡åˆ°BeanFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>registerNodeContextBean</span><span class=p>(</span><span class=n>beanFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ³¨å†ŒèŠ‚ç‚¹ä¸Šä¸‹æ–‡åˆ°BeanFactory
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>registerNodeContextBean</span><span class=p>(</span><span class=n>ConfigurableListableBeanFactory</span><span class=w> </span><span class=n>beanFactory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RedisNodeContext</span><span class=w> </span><span class=n>nodeContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RedisNodeContext</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>nodeContext</span><span class=p>.</span><span class=na>setAllNodes</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>HashSet</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>allNodes</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>unhealthyNodes</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>nodeContext</span><span class=p>.</span><span class=na>addUnhealthyNode</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>beanFactory</span><span class=p>.</span><span class=na>registerSingleton</span><span class=p>(</span><span class=s>&#34;redisNodeContext&#34;</span><span class=p>,</span><span class=w> </span><span class=n>nodeContext</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;RedisNodeContext registered as singleton bean&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ‰§è¡Œåˆå§‹å¥åº·æ£€æŸ¥
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>performInitialHealthCheck</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>oriRedisNodeUrl</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä¿å­˜æ‰€æœ‰åŸå§‹èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>allNodes</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>allNodes</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=n>oriRedisNodeUrl</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=n>Const</span><span class=p>.</span><span class=na>Symbol</span><span class=p>.</span><span class=na>Comma</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Starting initial Redis cluster health check for {} nodes&#34;</span><span class=p>,</span><span class=w> </span><span class=n>allNodes</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è¿‡æ»¤å¥åº·èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>healthyNodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>filterHealthyClusterNodes</span><span class=p>(</span><span class=n>oriRedisNodeUrl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>healthyNodes</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;No healthy Redis cluster nodes available&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>healthyRedisNodeUrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=n>Const</span><span class=p>.</span><span class=na>Symbol</span><span class=p>.</span><span class=na>Comma</span><span class=p>,</span><span class=w> </span><span class=n>healthyNodes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœæœ‰ä¸å¥åº·èŠ‚ç‚¹ï¼Œæ›´æ–°é…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>oriRedisNodeUrl</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>healthyRedisNodeUrl</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>updateRedisConfiguration</span><span class=p>(</span><span class=n>healthyRedisNodeUrl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;Redis configuration updated due to unhealthy nodes. Healthy nodes: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>healthyRedisNodeUrl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è®°å½•åˆå§‹å¥åº·çŠ¶æ€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Initial Redis cluster health status: {}/{} nodes healthy&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>(</span><span class=n>allNodes</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>unhealthyNodes</span><span class=p>.</span><span class=na>size</span><span class=p>()),</span><span class=w> </span><span class=n>allNodes</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Unhealthy nodes: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>unhealthyNodes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=nf>isRedisClusterEnabled</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>isEnabled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>environment</span><span class=p>.</span><span class=na>getProperty</span><span class=p>(</span><span class=s>&#34;è‡ªç ”åŒ….cluster.enabled&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isEnabled</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>Boolean</span><span class=p>.</span><span class=na>parseBoolean</span><span class=p>(</span><span class=n>isEnabled</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Boolean</span><span class=p>.</span><span class=na>FALSE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getOriRedisNodeUrl</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æå–é›†ç¾¤é…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>clusterNodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>environment</span><span class=p>.</span><span class=na>getProperty</span><span class=p>(</span><span class=s>&#34;spring.redis.cluster.nodes&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Redis cluster nodes configuration: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>clusterNodes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>clusterNodes</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>clusterNodes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getAuthPassword</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æå–è®¤è¯é…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>auth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>environment</span><span class=p>.</span><span class=na>getProperty</span><span class=p>(</span><span class=s>&#34;spring.redis.password&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>auth</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>auth</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>filterHealthyClusterNodes</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>oriRedisNodeUrl</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>healthyNodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>clusterNodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oriRedisNodeUrl</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=n>Const</span><span class=p>.</span><span class=na>Symbol</span><span class=p>.</span><span class=na>Comma</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>clusterNodes</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>checkRedisNode</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>healthyNodes</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Redis cluster node {} is healthy&#34;</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// èŠ‚ç‚¹ä¸å¥åº·ï¼Œè®°å½•åˆ°é™æ€é›†åˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>unhealthyNodes</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;Redis cluster node {} is unhealthy, added to monitoring list&#34;</span><span class=p>,</span><span class=w> </span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>healthyNodes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>checkRedisNode</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>parts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34;:&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>host</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parts</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parts</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>parseInt</span><span class=p>(</span><span class=n>parts</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>6379</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>Jedis</span><span class=w> </span><span class=n>jedis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Jedis</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=n>CONNECTION_TIMEOUT</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>auth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getAuthPassword</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>Objects</span><span class=p>.</span><span class=na>isNull</span><span class=p>(</span><span class=n>auth</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>jedis</span><span class=p>.</span><span class=na>auth</span><span class=p>(</span><span class=n>auth</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jedis</span><span class=p>.</span><span class=na>ping</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;PONG&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;Redis node {}:{} check failed: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updateRedisConfiguration</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>healthyRedisNodeUrl</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>updatedProperties</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ›´æ–°é›†ç¾¤é…ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>healthyRedisNodeUrl</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>updatedProperties</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;athena.redis.url&#34;</span><span class=p>,</span><span class=w> </span><span class=n>healthyRedisNodeUrl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>updatedProperties</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;spring.redis.cluster.nodes&#34;</span><span class=p>,</span><span class=w> </span><span class=n>healthyRedisNodeUrl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°†æ›´æ–°åçš„é…ç½®æ·»åŠ åˆ°Environmentçš„æœ€é«˜ä¼˜å…ˆçº§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>environment</span><span class=p>.</span><span class=na>getPropertySources</span><span class=p>().</span><span class=na>addFirst</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>MapPropertySource</span><span class=p>(</span><span class=s>&#34;redisHealthProperties&#34;</span><span class=p>,</span><span class=w> </span><span class=n>updatedProperties</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Redis configuration has been updated with healthy nodes: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>healthyRedisNodeUrl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * é™æ€æ–¹æ³•ä¾›å…¶ä»–ç»„ä»¶è®¿é—®
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getUnhealthyNodes</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashSet</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>unhealthyNodes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getAllNodes</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashSet</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>allNodes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isHealthCheckCompleted</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>healthCheckCompleted</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>open.ref.redis</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>è‡ªç ”åŒ….JedisFactoryClusterImpl</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>è‡ªç ”åŒ….RedisFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>open.svc.dict.Const</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.slf4j.Logger</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.slf4j.LoggerFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.scheduling.annotation.Scheduled</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.stereotype.Component</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>redis.clients.jedis.BinaryJedisCluster</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>redis.clients.jedis.Jedis</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>redis.clients.jedis.JedisCluster</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>redis.clients.jedis.JedisSlotBasedConnectionHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Field</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author huqinuo
</span></span></span><span class=line><span class=cl><span class=cm> * @version 1.0
</span></span></span><span class=line><span class=cl><span class=cm> * @description Redisé›†ç¾¤æ‹“æ‰‘åˆ·æ–°å™¨
</span></span></span><span class=line><span class=cl><span class=cm> * @data 2025/12/1 13:41
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RedisClusterTopologyRefresher</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Logger</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LoggerFactory</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=n>RedisClusterTopologyRefresher</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>RedisNodeContext</span><span class=w> </span><span class=n>redisNodeContext</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>RedisFactory</span><span class=w> </span><span class=n>redisFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Value</span><span class=p>(</span><span class=s>&#34;${è‡ªç ”åŒ…å¯†ç }&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>auth</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 2åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>REFRESH_INTERVAL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>60</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>1000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è¿æ¥è¶…æ—¶æ—¶é—´
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>CONNECTION_TIMEOUT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>5000</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ˜¯å¦åˆ·æ–°ä¸­
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isRefreshing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>RedisClusterTopologyRefresher</span><span class=p>(</span><span class=n>RedisNodeContext</span><span class=w> </span><span class=n>redisNodeContext</span><span class=p>,</span><span class=w> </span><span class=n>RedisFactory</span><span class=w> </span><span class=n>redisFactory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>redisNodeContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redisNodeContext</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>redisFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redisFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;RedisClusterTopologyRefresher initialized with {} unhealthy nodes&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>redisNodeContext</span><span class=p>.</span><span class=na>getUnhealthyNodeCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * å®šæ—¶åˆ·æ–°ä¸å¥åº·èŠ‚ç‚¹çš„æ‹“æ‰‘ä¿¡æ¯
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Scheduled</span><span class=p>(</span><span class=n>fixedRate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>REFRESH_INTERVAL</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>refreshTopologyForUnhealthyNodes</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isRefreshing</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Topology refresh is already in progress, skip this execution&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//ä»å•ä¸ªèŠ‚ç‚¹è·å–é›†ç¾¤ä¿¡æ¯ï¼Œå­˜åœ¨disconnectedè¿æ¥çŠ¶æ€èŠ‚ç‚¹åˆ™ä¸ºä¸å¥åº·</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>checkAllNodeIfExistUnhealthyNodes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>unhealthyNodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redisNodeContext</span><span class=p>.</span><span class=na>getUnhealthyNodes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unhealthyNodes</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;No unhealthy nodes to refresh&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Starting topology refresh for {} unhealthy nodes: {}&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>unhealthyNodes</span><span class=p>.</span><span class=na>size</span><span class=p>(),</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=s>&#34;,&#34;</span><span class=p>,</span><span class=w> </span><span class=n>unhealthyNodes</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>isRefreshing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>recoveredNodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashSet</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>unhealthyNodes</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>checkAndRefreshNode</span><span class=p>(</span><span class=n>node</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>recoveredNodes</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å¤„ç†æ¢å¤çš„èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>recoveredNodes</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>handleRecoveredNodes</span><span class=p>(</span><span class=n>recoveredNodes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Topology refresh completed. Recovered {} nodes, Redis cluster refresh status:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>recoveredNodes</span><span class=p>.</span><span class=na>size</span><span class=p>(),</span><span class=w> </span><span class=n>getRefreshStatus</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;Error during topology refresh&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>isRefreshing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>checkAllNodeIfExistUnhealthyNodes</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>allNodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redisNodeContext</span><span class=p>.</span><span class=na>getAllNodes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>oneNode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>allNodes</span><span class=p>.</span><span class=na>iterator</span><span class=p>().</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>parts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oneNode</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34;:&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>host</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parts</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parts</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>parseInt</span><span class=p>(</span><span class=n>parts</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>6379</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>Jedis</span><span class=w> </span><span class=n>jedis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Jedis</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=n>CONNECTION_TIMEOUT</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>jedis</span><span class=p>.</span><span class=na>auth</span><span class=p>(</span><span class=n>auth</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>clusterNodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jedis</span><span class=p>.</span><span class=na>clusterNodes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Redis cluster nodes : {}&#34;</span><span class=p>,</span><span class=n>clusterNodes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>lines</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>clusterNodes</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=n>Const</span><span class=p>.</span><span class=na>Symbol</span><span class=p>.</span><span class=na>BlankLine</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>line</span><span class=p>:</span><span class=n>lines</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>line</span><span class=p>.</span><span class=na>trim</span><span class=p>().</span><span class=na>isEmpty</span><span class=p>()){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>lineParts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>line</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34;\\s+&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>lineParts</span><span class=p>.</span><span class=na>length</span><span class=o>&lt;</span><span class=n>8</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>linkState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lineParts</span><span class=o>[</span><span class=n>7</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=s>&#34;disconnected&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>linkState</span><span class=p>)){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>String</span><span class=w> </span><span class=n>ipPortPart</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lineParts</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>String</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ipPortPart</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34;@&#34;</span><span class=p>)</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Find unheanthy Redis node : {}&#34;</span><span class=p>,</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>redisNodeContext</span><span class=p>.</span><span class=na>addUnhealthyNode</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;Exist unhealthy Redis node&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>redisNodeContext</span><span class=p>.</span><span class=na>addUnhealthyNode</span><span class=p>(</span><span class=n>oneNode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ£€æŸ¥å¹¶åˆ·æ–°å•ä¸ªèŠ‚ç‚¹
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param node
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>checkAndRefreshNode</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>parts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34;:&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>host</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parts</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parts</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>parseInt</span><span class=p>(</span><span class=n>parts</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>6379</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Checking node {}:{} for recovery&#34;</span><span class=p>,</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// é¦–å…ˆæ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æ¢å¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>checkNodeAvailability</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Node {}:{} is still unavailable&#34;</span><span class=p>,</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Node {}:{} is available again, refreshing topology&#34;</span><span class=p>,</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°è¯•åˆ·æ–°æ‹“æ‰‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>refreshSuccess</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>refreshNodeTopology</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>refreshSuccess</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Successfully refreshed topology for recovered node: {}:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;Node {}:{} is available but topology refresh failed&#34;</span><span class=p>,</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å¯ç”¨
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param host
</span></span></span><span class=line><span class=cl><span class=cm>     * @param port
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>checkNodeAvailability</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>Jedis</span><span class=w> </span><span class=n>jedis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Jedis</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=n>CONNECTION_TIMEOUT</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>jedis</span><span class=p>.</span><span class=na>auth</span><span class=p>(</span><span class=n>auth</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jedis</span><span class=p>.</span><span class=na>ping</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;PONG&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;Node {}:{} availability check failed: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * åˆ·æ–°èŠ‚ç‚¹æ‹“æ‰‘
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param host
</span></span></span><span class=line><span class=cl><span class=cm>     * @param port
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>refreshNodeTopology</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=n>Jedis</span><span class=w> </span><span class=n>jedis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Jedis</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=n>CONNECTION_TIMEOUT</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>jedis</span><span class=p>.</span><span class=na>auth</span><span class=p>(</span><span class=n>auth</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// éªŒè¯èŠ‚ç‚¹ç¡®å®æ˜¯é›†ç¾¤èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>clusterInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jedis</span><span class=p>.</span><span class=na>clusterInfo</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>clusterInfo</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=s>&#34;cluster_state:ok&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;Node {}:{} cluster state is not ok&#34;</span><span class=p>,</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// è·å–é›†ç¾¤æ§½ä½ä¿¡æ¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>slotInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jedis</span><span class=p>.</span><span class=na>clusterSlots</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>slotInfo</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>slotInfo</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;Node {}:{} returned empty cluster slots&#34;</span><span class=p>,</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Node {}:{} cluster slots info retrieved successfully&#34;</span><span class=p>,</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>topologyRefresh</span><span class=p>(</span><span class=n>jedis</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;Failed to refresh topology for node {}:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * æ‹“æ‰‘åˆ·æ–°
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param jedis
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>topologyRefresh</span><span class=p>(</span><span class=n>Jedis</span><span class=w> </span><span class=n>jedis</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>redisFactory</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>JedisFactoryClusterImpl</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redisFactory</span><span class=p>.</span><span class=na>getObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>JedisCluster</span><span class=w> </span><span class=n>jedisCluster</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>JedisCluster</span><span class=p>)</span><span class=w> </span><span class=n>obj</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Field</span><span class=w> </span><span class=n>connectionHandlerField</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BinaryJedisCluster</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;connectionHandler&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>connectionHandlerField</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Object</span><span class=w> </span><span class=n>connectionHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connectionHandlerField</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>jedisCluster</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>connectionHandler</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>JedisSlotBasedConnectionHandler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>JedisSlotBasedConnectionHandler</span><span class=w> </span><span class=n>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>JedisSlotBasedConnectionHandler</span><span class=p>)</span><span class=w> </span><span class=n>connectionHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>handler</span><span class=p>.</span><span class=na>renewSlotCache</span><span class=p>(</span><span class=n>jedis</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Topology refresh triggered for recovered nodes&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;Failed to trigger topology refresh&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * å¤„ç†æ¢å¤çš„èŠ‚ç‚¹
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param recoveredNodes
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleRecoveredNodes</span><span class=p>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>recoveredNodes</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ä»ä¸Šä¸‹æ–‡ä¸­ç§»é™¤æ¢å¤çš„èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>node</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>recoveredNodes</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>redisNodeContext</span><span class=p>.</span><span class=na>removeUnhealthyNode</span><span class=p>(</span><span class=n>node</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;{} nodes recovered and removed from unhealthy list: {}&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>recoveredNodes</span><span class=p>.</span><span class=na>size</span><span class=p>(),</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=s>&#34;,&#34;</span><span class=p>,</span><span class=w> </span><span class=n>recoveredNodes</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * è·å–åˆ·æ–°çŠ¶æ€æŠ¥å‘Š
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getRefreshStatus</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>status</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;unhealthyNodes&#34;</span><span class=p>,</span><span class=w> </span><span class=n>redisNodeContext</span><span class=p>.</span><span class=na>getUnhealthyNodes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>status</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;unhealthyNodeCount&#34;</span><span class=p>,</span><span class=w> </span><span class=n>redisNodeContext</span><span class=p>.</span><span class=na>getUnhealthyNodeCount</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>status</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;isRefreshing&#34;</span><span class=p>,</span><span class=w> </span><span class=n>isRefreshing</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>status</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;lastRefreshTime&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Date</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>status</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;refreshInterval&#34;</span><span class=p>,</span><span class=w> </span><span class=n>REFRESH_INTERVAL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=ç¬¬äºŒé˜¶æ®µé•¿æ•ˆè§£å†³æ‹“æ‰‘ç®¡ç†>ç¬¬äºŒé˜¶æ®µï¼šé•¿æ•ˆè§£å†³ï¼ˆæ‹“æ‰‘ç®¡ç†ï¼‰</h3><p><strong>æ–¹æ¡ˆ</strong>ï¼šå®ç°é›†ç¾¤æ‹“æ‰‘å®šæœŸåˆ·æ–°æœºåˆ¶</p><ol><li><strong>æ‹“æ‰‘åˆ·æ–°å™¨è®¾è®¡</strong>ï¼š<ul><li>åˆ·æ–°é¢‘ç‡ï¼šæ¯2åˆ†é’Ÿä¸€æ¬¡</li><li>åˆ·æ–°å†…å®¹ï¼šé›†ç¾¤èŠ‚ç‚¹çŠ¶æ€ã€ä¸»ä»å…³ç³»ã€slotåˆ†å¸ƒ</li><li>æ•…éšœæ£€æµ‹ï¼šè‡ªåŠ¨è¯†åˆ«å¹¶æ’é™¤æ•…éšœèŠ‚ç‚¹</li></ul></li><li><strong>æ¶æ„æ”¹è¿›</strong>ï¼š</li></ol><pre class=mermaid>
  graph TB
    subgraph "æ‹“æ‰‘åˆ·æ–°æ¶æ„"
        A[åº”ç”¨ç¨‹åºé›†ç¾¤] --> B[æ‹“æ‰‘åˆ·æ–°æœåŠ¡]
        B --> C[Redisé›†ç¾¤]
        B --> D[æœ¬åœ°æ‹“æ‰‘ç¼“å­˜]
        A --> D
    end
</pre><ol><li><strong>å…³é”®ç‰¹æ€§</strong>ï¼š<ul><li>å¼‚æ­¥åˆ·æ–°ï¼Œä¸å½±å“ä¸»ä¸šåŠ¡æµç¨‹</li><li>å¢é‡æ›´æ–°ï¼Œå‡å°‘ç½‘ç»œå¼€é”€</li><li>ç›‘æ§å‘Šè­¦ï¼ŒåŠæ—¶å‘ç°åˆ·æ–°å¼‚å¸¸</li></ul></li></ol><h2 id=ç»éªŒæ•™è®­ä¸æ”¹è¿›æªæ–½>ç»éªŒæ•™è®­ä¸æ”¹è¿›æªæ–½</h2><h3 id=é…ç½®ç®¡ç†æ”¹è¿›>é…ç½®ç®¡ç†æ”¹è¿›</h3><ol><li><strong>éƒ¨ç½²è§„èŒƒå¼ºåŒ–</strong><ul><li>å¼ºåˆ¶çº¦æŸï¼šåŒä¸€åˆ†ç‰‡çš„ä¸»ä»èŠ‚ç‚¹å¿…é¡»è·¨æ•°æ®ä¸­å¿ƒéƒ¨ç½²</li><li>è‡ªåŠ¨æ£€æŸ¥ï¼šéƒ¨ç½²æ—¶è‡ªåŠ¨éªŒè¯èŠ‚ç‚¹åˆ†å¸ƒåˆç†æ€§</li><li>å®šæœŸå®¡è®¡ï¼šæ¯æœˆè¿›è¡Œé›†ç¾¤é…ç½®åˆè§„æ€§æ£€æŸ¥</li></ul></li><li><strong>é…ç½®ç‰ˆæœ¬æ§åˆ¶</strong><ul><li>æ‰€æœ‰Redisé…ç½®å˜æ›´çº³å…¥ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿ</li><li>æ¼”ç»ƒæ“ä½œå¿…é¡»åŒ…å«å›æ»šæ–¹æ¡ˆå’ŒéªŒè¯æ­¥éª¤</li></ul></li></ol><h3 id=æ¡†æ¶å‡çº§ä¸ä¼˜åŒ–>æ¡†æ¶å‡çº§ä¸ä¼˜åŒ–</h3><ol><li><p><strong>å®¢æˆ·ç«¯å‡çº§è®¡åˆ’</strong></p><pre class=mermaid>
  timeline
    title Rediså®¢æˆ·ç«¯å‡çº§è·¯çº¿å›¾
    section çŸ­æœŸ
     ä¼˜åŒ–ç°æœ‰Jedis 2.9 : å¥åº·æ£€æŸ¥åŠæ‹“æ‰‘åˆ·æ–°
    section ä¸­æœŸ
     è¯„ä¼°å¹¶è¿ç§»åˆ°Jedisé«˜ç‰ˆæœ¬ : åº•å±‚APIä¸å…¼å®¹
    section é•¿æœŸ
     åº”ç”¨è®¾è®¡éœ€è€ƒè™‘redisé›†ç¾¤çŠ¶æ€ : ä½¿ç”¨æœ¬åœ°ç¼“å­˜æˆ–æ•°æ®åº“ä»£æ›¿
</pre></li><li><p><strong>å¥å£®æ€§å¢å¼º</strong></p><ul><li>å®ç°çŠ¶æ€æ£€æµ‹è¿æ¥ç­–ç•¥</li><li>å®Œå–„é™çº§æ–¹æ¡ˆ</li></ul></li></ol><h3 id=ç›‘æ§ä¸å‘Šè­¦å®Œå–„>ç›‘æ§ä¸å‘Šè­¦å®Œå–„</h3><ol><li><p><strong>æ–°å¢ç›‘æ§æŒ‡æ ‡</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ç›‘æ§æŒ‡æ ‡å®šä¹‰</span>
</span></span><span class=line><span class=cl><span class=n>redis_cluster_health</span> <span class=o>=</span> <span class=n>Gauge</span><span class=p>(</span><span class=s1>&#39;redis_cluster_health&#39;</span><span class=p>,</span> <span class=s1>&#39;Redisé›†ç¾¤å¥åº·çŠ¶æ€&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>redis_slot_coverage</span> <span class=o>=</span> <span class=n>Gauge</span><span class=p>(</span><span class=s1>&#39;redis_slot_coverage&#39;</span><span class=p>,</span> <span class=s1>&#39;Redis slotè¦†ç›–æ¯”ä¾‹&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>redis_node_distribution</span> <span class=o>=</span> <span class=n>Gauge</span><span class=p>(</span><span class=s1>&#39;redis_node_distribution&#39;</span><span class=p>,</span> <span class=s1>&#39;RedisèŠ‚ç‚¹åˆ†å¸ƒåˆè§„æ€§&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>redis_topology_refresh_latency</span> <span class=o>=</span> <span class=n>Histogram</span><span class=p>(</span><span class=s1>&#39;redis_topology_refresh_latency&#39;</span><span class=p>,</span> <span class=s1>&#39;æ‹“æ‰‘åˆ·æ–°å»¶è¿Ÿ&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>å‘Šè­¦è§„åˆ™ä¼˜åŒ–</strong></p><ul><li>ä¸»èŠ‚ç‚¹åŒæœºæˆ¿å‘Šè­¦</li><li>slotæœªè¦†ç›–å‘Šè­¦</li><li>æ‹“æ‰‘åˆ·æ–°å¤±è´¥å‘Šè­¦</li></ul></li></ol><h3 id=åº”æ€¥å“åº”æ”¹è¿›>åº”æ€¥å“åº”æ”¹è¿›</h3><ol><li><strong>é¢„æ¡ˆå®Œå–„</strong><ul><li>åˆ¶å®šRedisé›†ç¾¤éƒ¨åˆ†ä¸å¯ç”¨æ—¶çš„åº”æ€¥æ–¹æ¡ˆ</li><li>æ˜ç¡®é™çº§åœºæ™¯å’Œä¸šåŠ¡å½±å“èŒƒå›´</li></ul></li><li><strong>æ¼”ç»ƒå¸¸æ€åŒ–</strong><ul><li>æ¯å­£åº¦è¿›è¡ŒRedisæ•…éšœåˆ‡æ¢æ¼”ç»ƒ</li><li>æ¯å¹´è¿›è¡Œè·¨æ•°æ®ä¸­å¿ƒå®¹ç¾æ¼”ç»ƒ</li></ul></li></ol><h2 id=æ€»ç»“>æ€»ç»“</h2><p>æœ¬æ¬¡äº‹ä»¶æš´éœ²å‡ºæˆ‘ä»¬åœ¨Redisé›†ç¾¤ç®¡ç†ä¸­çš„å¤šä¸ªè–„å¼±ç¯èŠ‚ï¼ŒåŒ…æ‹¬å†å²æ“ä½œé—ç•™é—®é¢˜ã€å®¢æˆ·ç«¯æ¡†æ¶å±€é™æ€§ã€é…ç½®ä¸ä¸šåŠ¡éœ€æ±‚çš„çŸ›ç›¾ç­‰ã€‚é€šè¿‡æœ¬æ¬¡äº‹ä»¶çš„å¤„ç†ï¼Œæˆ‘ä»¬ä¸ä»…è§£å†³äº†å½“å‰é—®é¢˜ï¼Œæ›´é‡è¦çš„æ˜¯å»ºç«‹äº†ä¸€å¥—å®Œæ•´çš„é¢„é˜²å’Œæ”¹è¿›æœºåˆ¶ã€‚</p><p><strong>æ ¸å¿ƒå¯ç¤º</strong>ï¼š</p><ol><li><strong>æ¼”ç»ƒçš„çœŸå®æ€§</strong>ï¼šæ¼”ç»ƒå¿…é¡»å°½å¯èƒ½æ¨¡æ‹ŸçœŸå®æ•…éšœåœºæ™¯ï¼Œå¹¶åŠæ—¶æ¢å¤</li><li><strong>é…ç½®çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>ï¼šæ‰€æœ‰é…ç½®å˜æ›´å¿…é¡»æœ‰è·Ÿè¸ªã€æœ‰å®¡è®¡ã€æœ‰å›æ»š</li><li><strong>å®¢æˆ·ç«¯çš„å¥å£®æ€§</strong>ï¼šå®¢æˆ·ç«¯å¿…é¡»èƒ½å¤Ÿå¤„ç†é›†ç¾¤éƒ¨åˆ†æ•…éšœçš„æƒ…å†µ</li><li><strong>ç›‘æ§çš„å…¨é¢æ€§</strong>ï¼šç›‘æ§ä¸ä»…è¦å…³æ³¨æœåŠ¡çŠ¶æ€ï¼Œè¿˜è¦å…³æ³¨æ¶æ„åˆè§„æ€§</li></ol><p>æˆ‘ä»¬å°†ä»¥æ­¤äº‹ä»¶ä¸ºå¥‘æœºï¼Œå…¨é¢æå‡Redisé›†ç¾¤çš„ç¨³å®šæ€§å’Œå¯ç”¨æ€§ï¼Œç¡®ä¿é‡‘èä¸šåŠ¡çš„è¿ç»­æ€§å’Œæ•°æ®ä¸€è‡´æ€§ã€‚</p></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>æœ€åæ›´æ–°äº Dec 16, 2025 00:00 UTC</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/%E4%B8%8D%E5%90%8C%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/><div class=article-image><img src=/redis.jpeg loading=lazy data-key data-hash=/redis.jpeg></div><div class=article-details><h2 class=article-title>ä¸åŒéƒ¨ç½²æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯</h2></div></a></article><article class=has-image><a href=/p/redis%E4%BB%8B%E7%BB%8D/><div class=article-image><img src=/redis.jpeg loading=lazy data-key data-hash=/redis.jpeg></div><div class=article-details><h2 class=article-title>Redisä»‹ç»</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><script type=module>
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
        </script><footer class=site-footer><section class=copyright>&copy;
2022 -
2025 Ccinoçš„ä¸ªäººåšå®¢</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script type=module>
            import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
            mermaid.initialize({
              startOnLoad: true,
              theme: 'default',
            });
          </script><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>